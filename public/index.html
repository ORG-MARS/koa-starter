<!DOCTYPE html>
<head>
    <title>轻服务 starter</title>
    <meta name="viewport" content="width=device-width"/>
    <link rel="icon" href="images/favicon.png" sizes="32x32">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,100,700,100italic,300italic,400italic">
    <link rel="stylesheet"
          href="https://unpkg.com/vue-json-viewer@2.2.8/style.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css">

    <script src="https://unpkg.com/vue@2.6.10/dist/vue.min.js"></script>
    <script src="https://unpkg.com/axios@0.19.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue-json-viewer@2.2.8/vue-json-viewer.js"></script>
</head>

<body>
<div id="app" style="position: relative">
    <h1>待办事项 App</h1>

    <div class="request-logger" ref="logger">
        <h2 class="title">请求列表
        </h2>
        <div v-for="(lines,index) in requests" :key="index" class="request-card">
            <div v-for="(line, index) in lines" :key="index" class="request-line">
                <div v-if="typeof line === 'object'">
                    <json-viewer :value="line"
                                 theme="json-theme"
                                 expand-depth="1"></json-viewer>
                </div>
                <div v-else>
                    {{line}}
                </div>
            </div>
        </div>
    </div>

    <div class="readme">
        <h2 class="title">使用说明</h2>
        <div>
            轻服务云工程示例项目：
            <li>操作中间区域管理你的待办事项。</li>
            <li>左侧可以查看具体发生的请求。</li>
            <li>项目包含前端界面，后端接口，数据库操作。</li>
            <br/>
            创建自己的云工程：<a href="https://larkcloud.bytedance.net/docs/" target="_blank">轻服务文档</a>
        </div>
    </div>

    <div class="todo-wrapper">
        <form @keydown.enter.prevent="">
            <input type="text" class="input-todo" :class="{ active: newTodo }" placeholder="输入待办事项" v-model="newTodo"
                   @keyup.enter="addItem">
            <div class="btn btn-add" :class="{ active: newTodo }" @click="addItem">+</div>
        </form>


      <div hidden :hidden="loading">
        <div v-if="pending.length > 0">
            <p class="status busy">您拥有 {{ pending.length }} 条待办事项</p>
            <transition-group name="todo-item" tag="ul" class="todo-list">
                <li v-for="(item, index) in pending" :key="'item_' + item._id">
                    <input class="todo-checkbox" :id="'item_' + item._id" @change="updateToDone(item)"
                           type="checkbox">
                    <label :for="'item_' + item._id"></label>
                    <span class="todo-text">{{ item.title }}</span>
                    <span class="delete" @click="deleteItem(item)"></span>
                </li>
            </transition-group>
        </div>

        <transition name="slide-fade">
            <p class="status free" v-if="!loading&&!pending.length"><img src="images/beer_celebration.svg" alt="celebration">恭喜您，已完成所有待办事项！
            </p>
        </transition>

        <div v-if="completed.length > 0 && showComplete">
            <p class="status">已完成待办事项：{{ completedPercentage }}</p>
            <transition-group name="todo-item" tag="ul" class="todo-list archived">
                <li v-for="(item, index) in completed" :key="'item_' + item._id">
                    <input class="todo-checkbox" :id="'item_' + item._id" checked="checked"
                           @change="updateToUnDone(item)" type="checkbox">
                    <label :for="'item_' + item._id"></label>
                    <span class="todo-text">{{ item.title }}</span>
                    <span class="delete" @click="deleteItem(item)"></span>
                </li>
            </transition-group>
        </div>
        <div class="control-buttons">
            <div class="btn btn-secondary" v-if="completed.length > 0" @click="toggleShowComplete"><span
                    v-if="!showComplete">显示</span><span v-else>隐藏</span>已完成
            </div>
            <div class="btn btn-secondary" v-if="todoList.length > 0" @click="clearAll">清除所有</div>
        </div>
      </div>
    </div>

</div>
<footer>
<a href="https://larkcloud.com/" target="_blank">立即试用轻服务</a>
</footer>

</body>


<script>
  Vue.use(JsonView.default)
  new Vue({
    el: '#app',
    data () {
      return {
        todoList: [],
        newTodo: '',
        showComplete: true,
        loading: true,
        info: '',
        requests: [],
        request: [],
      }
    },
    async created () {
      this.interceptAxios()
      await this.getTodos()
      this.loading = false
    },
    computed: {
      pending: function () {
        return this.todoList.filter(function (item) {
          return !item.done
        })
      },
      completed: function () {
        return this.todoList.filter(function (item) {
          return item.done
        })
      },
      completedPercentage: function () {
        return (Math.floor((this.completed.length / this.todoList.length) * 100)) + '%'
      }

    },
    methods: {
      interceptAxios () {
        window.axios.interceptors.request.use(config => {
          let { method, url, data } = config
          this.request.push(`→ ${method.toUpperCase()} ${url}`)
          if (data) {
            this.request.push(data)
          }
          return config
        })
        window.axios.interceptors.response.use(resp => {
          let { status, data } = resp
          this.request.push(`← ${status}`)
          if (data) {
            this.request.push(data)
          }
          this.requests.push(this.request)
          this.setScroll()
          this.request = []
          return resp
        }, async err => {
          if (!err.response) {
            throw err
          }
          let { status, data } = err.response
          this.request.push(`← ${status}`)
          if (data) {
            this.request.push(data)
          }
          this.requests.push(this.request)
          this.setScroll()

          this.request = []

          throw err
        })
      },
      setScroll () {
        if (this.scrollTimer) clearTimeout(this.scrollTimer)
        this.scrollTimer = setTimeout(() => {
          this.$refs.logger.scrollTo({
            top: this.$refs.logger.scrollHeight + 1000,
            behavior: 'smooth'
          })
        }, 300)
      },
      toggleShowComplete () {
        this.showComplete = !this.showComplete
      },
      async getTodos () {
        this.todoList = await this.fetchListAction()
      },

      async updateToDone (item) {
        item.done = true
        await this.updateToDoneAction(item._id)
      },
      async updateToUnDone (item) {
        item.done = false
        await this.updateToUnDoneAction(item._id)
      },
      // add a new item
      async addItem () {
        // validation check
        if (this.newTodo) {
          let result = await this.addAction(this.newTodo)
          this.todoList.push(result)
        }
        // reset newTodo
        this.newTodo = ''
      },
      async deleteItem (item) {
        let index = this.todoList.indexOf(item)
        this.todoList.splice(index, 1)
        await this.deleteAction(item._id)
      },

      async clearAll () {
        await this.deleteAllAction()
        this.todoList = []
      },

      async addAction (title) {
        let { data: { result } } = await window.axios.post('/api/todo', { title })
        return result
      },
      async fetchListAction () {
        let { data: { list } } = await window.axios.get('/api/todo')
        return list
      },
      async deleteAction (id) {
        await window.axios.delete(`/api/todo/${id}`)
      },
      async deleteAllAction () {
        await window.axios.delete(`/api/todo`)
      },
      async updateToDoneAction (_id) {
        await window.axios.put(`/api/todo/${_id}/done`)
      },
      async updateToUnDoneAction (_id) {
        await window.axios.put(`/api/todo/${_id}/undone`)
      }
    }

  })
</script>
